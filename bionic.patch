From b5f7e8bcebbfaf9afe605432879918ed54638ab2 Mon Sep 17 00:00:00 2001
From: xc-racer99 <xc-racer2@live.ca>
Date: Tue, 12 Apr 2016 19:02:17 -0700
Subject: [PATCH 1/2] bionic: Restore non-pie support

---
 linker/Android.mk | 4 ++++
 linker/linker.cpp | 2 ++
 2 files changed, 6 insertions(+)

diff --git a/linker/Android.mk b/linker/Android.mk
index e5b2d1c..a092747 100644
--- a/linker/Android.mk
+++ b/linker/Android.mk
@@ -58,6 +58,10 @@ ifeq ($(TARGET_NEEDS_PLATFORM_TEXTRELS),true)
 LOCAL_CFLAGS += -DALLOW_PLATFORM_TEXTRELS
 endif
 
+ifeq ($(TARGET_ENABLE_NON_PIE_SUPPORT),true)
+    LOCAL_CFLAGS += -DENABLE_NON_PIE_SUPPORT
+endif
+
 # We need to access Bionic private headers in the linker.
 LOCAL_CFLAGS += -I$(LOCAL_PATH)/../libc/
 
diff --git a/linker/linker.cpp b/linker/linker.cpp
index 9ecf74c..c476cfd 100644
--- a/linker/linker.cpp
+++ b/linker/linker.cpp
@@ -4284,11 +4284,13 @@ static ElfW(Addr) __linker_init_post_relocation(KernelArgumentBlock& args, ElfW(
   }
   si->dynamic = nullptr;
 
+#ifndef ENABLE_NON_PIE_SUPPORT
   ElfW(Ehdr)* elf_hdr = reinterpret_cast<ElfW(Ehdr)*>(si->base);
   if (elf_hdr->e_type != ET_DYN) {
     __libc_fatal("\"%s\": error: only position independent executables (PIE) are supported.",
                  args.argv[0]);
   }
+#endif
 
   // Use LD_LIBRARY_PATH and LD_PRELOAD (but only if we aren't setuid/setgid).
   parse_LD_LIBRARY_PATH(ldpath_env);
-- 
2.19.2


From a95aa338458d72dcf70926b3c47cbda82efb2f7f Mon Sep 17 00:00:00 2001
From: Tom Marshall <tdm@cyngn.com>
Date: Tue, 3 Nov 2015 11:12:23 -0800
Subject: [PATCH 2/2] bionic: Let popen fall back to /sbin/sh

minivold in recovery uses popen, where /system/bin/sh is not available.

Change-Id: I2136b0ca4188b7b44416f5d79492fc006382d4ad
---
 libc/include/paths.h                      | 1 +
 libc/upstream-netbsd/lib/libc/gen/popen.c | 2 ++
 2 files changed, 3 insertions(+)

diff --git a/libc/include/paths.h b/libc/include/paths.h
index 82c28042f..7700cdd66 100644
--- a/libc/include/paths.h
+++ b/libc/include/paths.h
@@ -33,6 +33,7 @@
 #define	_PATHS_H_
 
 #define	_PATH_BSHELL	"/system/bin/sh"
+#define	_PATH_BSHELL2	"/sbin/sh"
 #define	_PATH_CONSOLE	"/dev/console"
 #define	_PATH_DEFPATH	"/sbin:/vendor/bin:/system/sbin:/system/bin:/system/xbin"
 #define	_PATH_DEV	"/dev/"
diff --git a/libc/upstream-netbsd/lib/libc/gen/popen.c b/libc/upstream-netbsd/lib/libc/gen/popen.c
index 593e34631..b6ce47c5d 100644
--- a/libc/upstream-netbsd/lib/libc/gen/popen.c
+++ b/libc/upstream-netbsd/lib/libc/gen/popen.c
@@ -152,6 +152,8 @@ popen(const char *command, const char *type)
 		}
 
 		execl(_PATH_BSHELL, "sh", "-c", command, NULL);
+		if (errno == ENOENT)
+			execl(_PATH_BSHELL2, "sh", "-c", command, NULL);
 		_exit(127);
 		/* NOTREACHED */
 	}
-- 
2.11.0

